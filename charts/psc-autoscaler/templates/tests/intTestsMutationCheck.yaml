{{- $fullName := include "helm.fullname" . -}}
{{- if .Values.integrationTests.enabled -}}
apiVersion: v1
kind: Pod
metadata:
  name: {{ include "psc-autoscaler.fullname" . }}-int-tests-mutation-check
  labels: {{- include "psc-autoscaler.labels" . | nindent 4 }}
    {{- if .Values.additionalLabels }}
    {{- toYaml .Values.additionalLabels | nindent 4 }}
    {{- end }}
  annotations:
    "helm.sh/hook": test
    {{- with .Values.annotations }}
      {{- toYaml . | nindent 4 }}
    {{- end }}
spec:
  containers:
    - name: mutation-check
      image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
      command:
        - "./app"
        - "helm-test"
      env:
       - name: ENV
         value: "{{ .Values.settings.env }}"
       - name: CLEANUP
         value: {{ .Values.integrationTests.settings.cleanup | quote }}
       - name: PS_URL
         value: "{{ .Values.settings.psUrl }}"
       - name: CLIENT_ID
         valueFrom:
           secretKeyRef:
             name: {{ .Values.secret.name | default $fullName }}
             key: "clientId"
             optional: false
       - name: CLIENT_SECRET
         valueFrom:
           secretKeyRef:
             name: {{ .Values.secret.name | default $fullName }}
             key: "clientSecret"
             optional: false
      resources:
        {{- toYaml .Values.cmd.serve.resources | nindent 8 }}
  restartPolicy: Never
  serviceAccountName: {{ include "psc-autoscaler.integrationTests.serviceAccountName" . }}
{{ end }}
